<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mood Reports - Wellbeing Assistant Admin</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', sans-serif;
        }

        body {
            background: linear-gradient(135deg, #0f0f23 0%, #1a1a3e 50%, #2d1b69 100%);
            color: #e0e7ff;
            min-height: 100vh;
        }
        
        .container {
            display: flex;
            min-height: 100vh;
        }
        
        .sidebar {
            width: 260px;
            background: rgba(15, 15, 35, 0.9);
            backdrop-filter: blur(20px);
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            padding: 20px 0;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            box-shadow: 0 0 25px rgba(0, 0, 0, 0.3);
            z-index: 100;
        }
        
        .sidebar h2 {
            padding: 0 20px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 20px;
            background: linear-gradient(135deg, #8b5cf6, #ec4899);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: 700;
        }
        
        .sidebar ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        
        .sidebar ul li {
            margin-bottom: 5px;
        }
        
        .sidebar ul li a {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            color: #a78bfa;
            text-decoration: none;
            transition: all 0.3s ease;
            border-radius: 0 20px 20px 0;
            margin-right: 1rem;
        }
        
        .sidebar ul li a:hover {
            background: rgba(139, 92, 246, 0.2);
            color: #c4b5fd;
            transform: translateX(8px);
        }
        
        .sidebar ul li.active a {
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
            color: white;
            box-shadow: 0 8px 25px rgba(139, 92, 246, 0.4);
        }
        
        .sidebar ul li a i {
            margin-right: 10px;
            width: 20px;
            text-align: center;
        }
        
        .main-content {
            flex: 1;
            margin-left: 260px;
            padding: 30px;
        }
        
        h1 {
            margin-bottom: 30px;
            color: #e0e7ff;
            font-weight: 600;
            font-size: 28px;
            background: linear-gradient(135deg, #8b5cf6, #ec4899);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        h2 {
            margin: 30px 0 20px;
            color: #e0e7ff;
            font-weight: 600;
            font-size: 20px;
        }
        
        h3 {
            color: #a78bfa;
            font-weight: 500;
            font-size: 14px;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        /* Glass cards */
        .glass-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
            padding: 20px;
            margin-bottom: 30px;
        }
        
        .glass-card:hover {
            background: rgba(255, 255, 255, 0.08);
            transform: translateY(-2px);
        }
        
        /* Filters */
        .filters-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
        }
        
        .filter-group label {
            color: #a78bfa;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 8px;
        }
        
        .filter-group select {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            color: #e0e7ff;
            padding: 12px 16px;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        .filter-group select:focus {
            outline: none;
            border-color: #8b5cf6;
            box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.2);
        }
        
        .filter-group select option {
            background: #1a1a3e;
            color: #e0e7ff;
        }
        
        /* Stats cards */
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 20px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(139, 92, 246, 0.3);
        }
        
        .stat-number {
            display: block;
            font-size: 28px;
            font-weight: 700;
            color: #8b5cf6;
            margin-top: 5px;
        }
        
        .stat-subtitle {
            font-size: 12px;
            color: #a78bfa;
            margin-top: 5px;
        }
        
        /* Charts */
        .chart-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 30px;
            margin-bottom: 30px;
        }
        
        .chart-container {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 20px;
            height: 400px;
        }
        
        .chart-container h3 {
            margin-bottom: 20px;
            color: #e0e7ff;
            font-size: 16px;
            font-weight: 600;
            text-transform: none;
            letter-spacing: normal;
        }
        
        /* Mood distribution */
        .mood-pills {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }
        
        .mood-pill {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 8px 16px;
            font-size: 12px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .mood-pill.happy { border-left: 4px solid #10b981; }
        .mood-pill.energetic { border-left: 4px solid #f59e0b; }
        .mood-pill.neutral { border-left: 4px solid #6b7280; }
        .mood-pill.sad { border-left: 4px solid #3b82f6; }
        .mood-pill.anxious { border-left: 4px solid #ef4444; }
        
        /* Risk indicators */
        .risk-section {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-left: 4px solid #ef4444;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
        }
        
        .risk-section h3 {
            color: #fca5a5;
            margin-bottom: 15px;
        }
        
        .risk-item {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            border-left: 3px solid #ef4444;
        }
        
        .risk-item:last-child {
            margin-bottom: 0;
        }
        
        /* Triggers */
        .trigger-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .trigger-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            transition: all 0.3s ease;
        }
        
        .trigger-item:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-2px);
        }
        
        .trigger-count {
            font-size: 20px;
            font-weight: 700;
            color: #8b5cf6;
            display: block;
        }
        
        .trigger-name {
            font-size: 12px;
            color: #a78bfa;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-top: 5px;
        }
        
        /* Buttons */
        .btn {
            padding: 12px 24px;
            border-radius: 12px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            font-size: 14px;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(139, 92, 246, 0.4);
        }
        
        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: #e0e7ff;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.15);
            border-color: #8b5cf6;
        }
        
        /* Loading */
        .loading {
            display: none;
            text-align: center;
            padding: 40px;
            color: #a78bfa;
        }
        
        .spinner {
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top: 2px solid #8b5cf6;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Flash messages */
        .flash-message {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.3);
            border-left: 4px solid #10b981;
            color: #6ee7b7;
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 20px;
        }
        
        /* Responsive */
        @media (max-width: 1024px) {
            .sidebar {
                transform: translateX(-100%);
            }
            
            .main-content {
                margin-left: 0;
            }
            
            .chart-grid {
                grid-template-columns: 1fr;
            }
            
            .filters-section {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <aside class="sidebar">
            <h2>Admin Panel</h2>
            <ul>
                <li><a href="{{ url_for('admin.dashboard') }}"><i class="fas fa-chart-line"></i> Dashboard</a></li>
                <li><a href="{{ url_for('admin.user_management') }}"><i class="fas fa-users"></i> User Management</a></li>
                <li class="active"><a href="{{ url_for('admin.mood_reports') }}"><i class="fas fa-brain"></i> Mood Reports</a></li>
                <li><a href="{{ url_for('admin.moderation_dashboard') }}"><i class="fas fa-shield-alt"></i> Moderation Center</a></li>
                <li><a href="{{ url_for('admin.chat_logs') }}"><i class="fas fa-comments"></i> Chat Logs</a></li>
                <li><a href="{{ url_for('admin.budget_dashboard') }}"><i class="fas fa-dollar-sign"></i> Budget Dashboard</a></li>
                <li><a href="{{ url_for('admin.resources') }}"><i class="fas fa-book"></i> Resource Management</a></li>
                <li><a href="{{ url_for('admin.settings') }}"><i class="fas fa-cog"></i> System Settings</a></li>
                <li><a href="{{ url_for('auth.logout') }}"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
            </ul>
        </aside>
        
        <div class="main-content">
            <!-- Flash messages -->
            {% with messages = get_flashed_messages() %}
                {% if messages %}
                    {% for message in messages %}
                        <div class="flash-message">
                            <i class="fas fa-info-circle mr-2"></i>{{ message }}
                        </div>
                    {% endfor %}
                {% endif %}
            {% endwith %}
            
            <h1><i class="fas fa-brain mr-3"></i>Student Mood Analytics</h1>
            
            <!-- Filters -->
            <div class="glass-card">
                <h3>Filters & Actions</h3>
                <div class="filters-section">
                    <div class="filter-group">
                        <label for="dateRange">Date Range</label>
                        <select id="dateRange" onchange="updateReports()">
                            <option value="7_days" {{ 'selected' if selected_range == '7_days' }}>Last 7 Days</option>
                            <option value="30_days" {{ 'selected' if selected_range == '30_days' }}>Last 30 Days</option>
                            <option value="90_days" {{ 'selected' if selected_range == '90_days' }}>Last 90 Days</option>
                            <option value="1_year" {{ 'selected' if selected_range == '1_year' }}>Last Year</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="userFilter">Filter by User</label>
                        <select id="userFilter" onchange="updateReports()">
                            <option value="">All Users</option>
                            {% for user in users %}
                            <option value="{{ user._id }}" {{ 'selected' if selected_user == user._id|string }}>
                                {{ user.name or user.email }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div style="margin-top: 20px;">
                    <button onclick="exportReport()" class="btn btn-primary">
                        <i class="fas fa-download mr-2"></i>Export CSV Report
                    </button>
                    <button onclick="updateReports()" class="btn btn-secondary">
                        <i class="fas fa-sync-alt mr-2"></i>Refresh Data
                    </button>
                </div>
            </div>
            
            <!-- Loading indicator -->
            <div class="loading" id="loadingIndicator">
                <div class="spinner"></div>
                Loading mood analytics...
            </div>
            
            <!-- Key Statistics -->
            <div class="stats" id="keyStats">
                <div class="card">
                    <h3>Total Mood Entries</h3>
                    <span class="stat-number" id="totalEntries">{{ analytics.total_entries }}</span>
                    <div class="stat-subtitle">From {{ analytics.date_range.start }} to {{ analytics.date_range.end }}</div>
                </div>
                <div class="card">
                    <h3>Active Students</h3>
                    <span class="stat-number" id="uniqueUsers">{{ analytics.unique_users }}</span>
                    <div class="stat-subtitle">Students tracking their mood</div>
                </div>
                <div class="card">
                    <h3>Average Mood Intensity</h3>
                    <span class="stat-number" id="avgIntensity">{{ analytics.intensity_data.average }}</span>
                    <div class="stat-subtitle">Out of 10 scale</div>
                </div>
                <div class="card">
                    <h3>Positive Mood Rate</h3>
                    <span class="stat-number" id="positiveRate">
                        {{ (analytics.mood_percentages.happy + analytics.mood_percentages.energetic)|round(1) }}%
                    </span>
                    <div class="stat-subtitle">Happy + Energetic moods</div>
                </div>
            </div>
            
            <!-- Risk Indicators -->
            {% if analytics.risk_indicators.high_risk_user_count > 0 %}
            <div class="risk-section" id="riskSection">
                <h3><i class="fas fa-exclamation-triangle mr-2"></i>Risk Indicators</h3>
                <div style="margin-bottom: 15px;">
                    <strong>{{ analytics.risk_indicators.high_risk_user_count }}</strong> students showing concerning mood patterns
                    ({{ analytics.risk_indicators.overall_risk_percentage }}% negative mood entries in recent week)
                </div>
                <div id="riskPatterns">
                    {% for pattern in analytics.risk_indicators.concerning_patterns %}
                    <div class="risk-item">
                        <strong>User {{ pattern.user_id[:8] }}...</strong>: {{ pattern.negative_percentage }}% negative moods 
                        ({{ pattern.total_entries }} entries) - {{ pattern.pattern }}
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
            
            <!-- Charts Grid -->
            <div class="chart-grid">
                <!-- Daily Trends Chart -->
                <div class="chart-container">
                    <h3><i class="fas fa-chart-line mr-2"></i>Daily Mood Trends</h3>
                    <canvas id="dailyTrendsChart"></canvas>
                </div>
                
                <!-- Mood Distribution Chart -->
                <div class="chart-container">
                    <h3><i class="fas fa-chart-pie mr-2"></i>Overall Mood Distribution</h3>
                    <canvas id="moodDistributionChart"></canvas>
                </div>
                
                <!-- Weekly Patterns Chart -->
                <div class="chart-container">
                    <h3><i class="fas fa-calendar-week mr-2"></i>Weekly Patterns</h3>
                    <canvas id="weeklyPatternsChart"></canvas>
                </div>
                
                <!-- Intensity Distribution Chart -->
                <div class="chart-container">
                    <h3><i class="fas fa-chart-bar mr-2"></i>Mood Intensity Distribution</h3>
                    <canvas id="intensityChart"></canvas>
                </div>
            </div>
            
            <!-- Mood Details -->
            <div class="glass-card">
                <h2><i class="fas fa-heart mr-2"></i>Mood Breakdown</h2>
                <div class="mood-pills" id="moodPills">
                    <div class="mood-pill happy">
                        <i class="fas fa-smile"></i>
                        <span>Happy: {{ analytics.mood_percentages.happy }}% ({{ analytics.mood_distribution.happy }})</span>
                    </div>
                    <div class="mood-pill energetic">
                        <i class="fas fa-bolt"></i>
                        <span>Energetic: {{ analytics.mood_percentages.energetic }}% ({{ analytics.mood_distribution.energetic }})</span>
                    </div>
                    <div class="mood-pill neutral">
                        <i class="fas fa-meh"></i>
                        <span>Neutral: {{ analytics.mood_percentages.neutral }}% ({{ analytics.mood_distribution.neutral }})</span>
                    </div>
                    <div class="mood-pill sad">
                        <i class="fas fa-frown"></i>
                        <span>Sad: {{ analytics.mood_percentages.sad }}% ({{ analytics.mood_distribution.sad }})</span>
                    </div>
                    <div class="mood-pill anxious">
                        <i class="fas fa-dizzy"></i>
                        <span>Anxious: {{ analytics.mood_percentages.anxious }}% ({{ analytics.mood_distribution.anxious }})</span>
                    </div>
                </div>
            </div>
            
            <!-- Top Triggers -->
            <div class="glass-card">
                <h2><i class="fas fa-lightbulb mr-2"></i>Most Common Mood Triggers</h2>
                <div class="trigger-grid" id="triggerGrid">
                    {% for trigger in analytics.trigger_data.top_triggers[:8] %}
                    <div class="trigger-item">
                        <span class="trigger-count">{{ trigger.count }}</span>
                        <div class="trigger-name">{{ trigger.name.title() }}</div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            
            <!-- User Engagement -->
            <div class="glass-card">
                <h2><i class="fas fa-users mr-2"></i>Student Engagement</h2>
                <div class="stats">
                    <div class="card">
                        <h3>Highly Engaged</h3>
                        <span class="stat-number">{{ analytics.user_engagement.engagement_distribution.high or 0 }}</span>
                        <div class="stat-subtitle">20+ mood entries</div>
                    </div>
                    <div class="card">
                        <h3>Moderately Engaged</h3>
                        <span class="stat-number">{{ analytics.user_engagement.engagement_distribution.medium or 0 }}</span>
                        <div class="stat-subtitle">10-19 mood entries</div>
                    </div>
                    <div class="card">
                        <h3>Low Engagement</h3>
                        <span class="stat-number">{{ analytics.user_engagement.engagement_distribution.low or 0 }}</span>
                        <div class="stat-subtitle">1-9 mood entries</div>
                    </div>
                    <div class="card">
                        <h3>Avg. Entries per Student</h3>
                        <span class="stat-number">{{ analytics.user_engagement.avg_entries_per_user }}</span>
                        <div class="stat-subtitle">In selected time period</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentAnalytics = {{ analytics|tojson }};
        let dailyChart, moodChart, weeklyChart, intensityChart;
        
        // Initialize charts when page loads
        document.addEventListener('DOMContentLoaded', function() {
            initializeCharts();
        });
        
        // Initialize all charts
        function initializeCharts() {
            initDailyTrendsChart();
            initMoodDistributionChart();
            initWeeklyPatternsChart();
            initIntensityChart();
        }
        
        // Daily trends chart
        function initDailyTrendsChart() {
            const ctx = document.getElementById('dailyTrendsChart').getContext('2d');
            
            if (dailyChart) {
                dailyChart.destroy();
            }
            
            dailyChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: currentAnalytics.daily_trends.labels,
                    datasets: [
                        {
                            label: 'Positive Moods',
                            data: currentAnalytics.daily_trends.positive_trend,
                            backgroundColor: 'rgba(16, 185, 129, 0.2)',
                            borderColor: '#10b981',
                            borderWidth: 3,
                            tension: 0.4,
                            fill: true
                        },
                        {
                            label: 'Neutral Moods',
                            data: currentAnalytics.daily_trends.neutral_trend,
                            backgroundColor: 'rgba(107, 114, 128, 0.2)',
                            borderColor: '#6b7280',
                            borderWidth: 2,
                            tension: 0.4,
                            fill: false
                        },
                        {
                            label: 'Negative Moods',
                            data: currentAnalytics.daily_trends.negative_trend,
                            backgroundColor: 'rgba(239, 68, 68, 0.2)',
                            borderColor: '#ef4444',
                            borderWidth: 3,
                            tension: 0.4,
                            fill: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: { color: '#a78bfa' }
                        }
                    },
                    scales: {
                        x: {
                            ticks: { color: '#a78bfa' },
                            grid: { color: 'rgba(167, 139, 250, 0.1)' }
                        },
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: { 
                                color: '#a78bfa',
                                callback: function(value) {
                                    return value + '%';
                                }
                            },
                            grid: { color: 'rgba(167, 139, 250, 0.1)' }
                        }
                    }
                }
            });
        }
        
        // Mood distribution chart
        function initMoodDistributionChart() {
            const ctx = document.getElementById('moodDistributionChart').getContext('2d');
            
            if (moodChart) {
                moodChart.destroy();
            }
            
            moodChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Happy', 'Energetic', 'Neutral', 'Sad', 'Anxious'],
                    datasets: [{
                        data: [
                            currentAnalytics.mood_distribution.happy,
                            currentAnalytics.mood_distribution.energetic,
                            currentAnalytics.mood_distribution.neutral,
                            currentAnalytics.mood_distribution.sad,
                            currentAnalytics.mood_distribution.anxious
                        ],
                        backgroundColor: [
                            '#10b981',  // Happy - green
                            '#f59e0b',  // Energetic - orange
                            '#6b7280',  // Neutral - gray
                            '#3b82f6',  // Sad - blue
                            '#ef4444'   // Anxious - red
                        ],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { 
                                color: '#a78bfa',
                                padding: 20
                            }
                        }
                    }
                }
            });
        }
        
        // Weekly patterns chart
        function initWeeklyPatternsChart() {
            const ctx = document.getElementById('weeklyPatternsChart').getContext('2d');
            
            if (weeklyChart) {
                weeklyChart.destroy();
            }
            
            weeklyChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: currentAnalytics.weekly_patterns.labels,
                    datasets: [
                        {
                            label: 'Happy',
                            data: currentAnalytics.weekly_patterns.happy,
                            backgroundColor: '#10b981'
                        },
                        {
                            label: 'Energetic',
                            data: currentAnalytics.weekly_patterns.energetic,
                            backgroundColor: '#f59e0b'
                        },
                        {
                            label: 'Neutral',
                            data: currentAnalytics.weekly_patterns.neutral,
                            backgroundColor: '#6b7280'
                        },
                        {
                            label: 'Sad',
                            data: currentAnalytics.weekly_patterns.sad,
                            backgroundColor: '#3b82f6'
                        },
                        {
                            label: 'Anxious',
                            data: currentAnalytics.weekly_patterns.anxious,
                            backgroundColor: '#ef4444'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            stacked: true,
                            ticks: { color: '#a78bfa' },
                            grid: { color: 'rgba(167, 139, 250, 0.1)' }
                        },
                        y: {
                            stacked: true,
                            beginAtZero: true,
                            max: 100,
                            ticks: { 
                                color: '#a78bfa',
                                callback: function(value) {
                                    return value + '%';
                                }
                            },
                            grid: { color: 'rgba(167, 139, 250, 0.1)' }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: { color: '#a78bfa' }
                        }
                    }
                }
            });
        }
        
        // Intensity distribution chart
        function initIntensityChart() {
            const ctx = document.getElementById('intensityChart').getContext('2d');
            
            if (intensityChart) {
                intensityChart.destroy();
            }
            
            const intensityData = currentAnalytics.intensity_data.distribution;
            const labels = Object.keys(intensityData).sort((a, b) => parseInt(a) - parseInt(b));
            const data = labels.map(label => intensityData[label]);
            
            intensityChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels.map(l => `Level ${l}`),
                    datasets: [{
                        label: 'Number of Entries',
                        data: data,
                        backgroundColor: '#8b5cf6',
                        borderColor: '#7c3aed',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: { color: '#a78bfa' }
                        }
                    },
                    scales: {
                        x: {
                            ticks: { color: '#a78bfa' },
                            grid: { color: 'rgba(167, 139, 250, 0.1)' }
                        },
                        y: {
                            beginAtZero: true,
                            ticks: { color: '#a78bfa' },
                            grid: { color: 'rgba(167, 139, 250, 0.1)' }
                        }
                    }
                }
            });
        }
        
        // Update reports based on filters
        function updateReports() {
            const dateRange = document.getElementById('dateRange').value;
            const userFilter = document.getElementById('userFilter').value;
            
            document.getElementById('loadingIndicator').style.display = 'block';
            
            const params = new URLSearchParams({
                range: dateRange
            });
            
            if (userFilter) {
                params.append('user_id', userFilter);
            }
            
            fetch(`{{ url_for("admin.api_mood_analytics") }}?${params}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        currentAnalytics = data.data;
                        updateUI();
                        initializeCharts();
                    } else {
                        alert('Error loading data: ' + data.error);
                    }
                    document.getElementById('loadingIndicator').style.display = 'none';
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error loading data. Please try again.');
                    document.getElementById('loadingIndicator').style.display = 'none';
                });
        }
        
        // Update UI elements with new data
        function updateUI() {
            // Update key stats
            document.getElementById('totalEntries').textContent = currentAnalytics.total_entries;
            document.getElementById('uniqueUsers').textContent = currentAnalytics.unique_users;
            document.getElementById('avgIntensity').textContent = currentAnalytics.intensity_data.average;
            
            const positiveRate = (currentAnalytics.mood_percentages.happy + currentAnalytics.mood_percentages.energetic).toFixed(1);
            document.getElementById('positiveRate').textContent = positiveRate + '%';
            
            // Update mood pills
            updateMoodPills();
            
            // Update triggers
            updateTriggers();
            
            // Update risk indicators
            updateRiskIndicators();
        }
        
        // Update mood pills
        function updateMoodPills() {
            const pillsContainer = document.getElementById('moodPills');
            const moods = ['happy', 'energetic', 'neutral', 'sad', 'anxious'];
            const icons = ['fas fa-smile', 'fas fa-bolt', 'fas fa-meh', 'fas fa-frown', 'fas fa-dizzy'];
            
            pillsContainer.innerHTML = '';
            
            moods.forEach((mood, index) => {
                const pill = document.createElement('div');
                pill.className = `mood-pill ${mood}`;
                pill.innerHTML = `
                    <i class="${icons[index]}"></i>
                    <span>${mood.charAt(0).toUpperCase() + mood.slice(1)}: ${currentAnalytics.mood_percentages[mood]}% (${currentAnalytics.mood_distribution[mood]})</span>
                `;
                pillsContainer.appendChild(pill);
            });
        }
        
        // Update triggers grid
        function updateTriggers() {
            const triggerGrid = document.getElementById('triggerGrid');
            triggerGrid.innerHTML = '';
            
            currentAnalytics.trigger_data.top_triggers.slice(0, 8).forEach(trigger => {
                const triggerItem = document.createElement('div');
                triggerItem.className = 'trigger-item';
                triggerItem.innerHTML = `
                    <span class="trigger-count">${trigger.count}</span>
                    <div class="trigger-name">${trigger.name.charAt(0).toUpperCase() + trigger.name.slice(1)}</div>
                `;
                triggerGrid.appendChild(triggerItem);
            });
        }
        
        // Update risk indicators
        function updateRiskIndicators() {
            const riskSection = document.getElementById('riskSection');
            
            if (currentAnalytics.risk_indicators.high_risk_user_count > 0) {
                if (riskSection) {
                    riskSection.style.display = 'block';
                } else {
                    // Create risk section if it doesn't exist
                    const newRiskSection = document.createElement('div');
                    newRiskSection.className = 'risk-section';
                    newRiskSection.id = 'riskSection';
                    // Insert after stats section
                    const stats = document.getElementById('keyStats');
                    stats.parentNode.insertBefore(newRiskSection, stats.nextSibling);
                }
                
                // Update content
                document.getElementById('riskSection').innerHTML = `
                    <h3><i class="fas fa-exclamation-triangle mr-2"></i>Risk Indicators</h3>
                    <div style="margin-bottom: 15px;">
                        <strong>${currentAnalytics.risk_indicators.high_risk_user_count}</strong> students showing concerning mood patterns
                        (${currentAnalytics.risk_indicators.overall_risk_percentage}% negative mood entries in recent week)
                    </div>
                    <div id="riskPatterns">
                        ${currentAnalytics.risk_indicators.concerning_patterns.map(pattern => `
                            <div class="risk-item">
                                <strong>User ${pattern.user_id.substring(0, 8)}...</strong>: ${pattern.negative_percentage}% negative moods 
                                (${pattern.total_entries} entries) - ${pattern.pattern}
                            </div>
                        `).join('')}
                    </div>
                `;
            } else if (riskSection) {
                riskSection.style.display = 'none';
            }
        }
        
        // Export report
        function exportReport() {
            const dateRange = document.getElementById('dateRange').value;
            const userFilter = document.getElementById('userFilter').value;
            
            const params = new URLSearchParams({
                range: dateRange
            });
            
            if (userFilter) {
                params.append('user_id', userFilter);
            }
            
            window.location.href = `{{ url_for("admin.export_mood_report") }}?${params}`;
        }
        
        console.log('Mood reports dashboard loaded');
    </script>
</body>
</html>