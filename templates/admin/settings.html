<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Settings - Wellbeing Assistant Admin</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', sans-serif;
        }

        body {
            background: linear-gradient(135deg, #0f0f23 0%, #1a1a3e 50%, #2d1b69 100%);
            color: #e0e7ff;
            min-height: 100vh;
        }
        
        .container {
            display: flex;
            min-height: 100vh;
        }
        
        .sidebar {
            width: 260px;
            background: rgba(15, 15, 35, 0.9);
            backdrop-filter: blur(20px);
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            padding: 20px 0;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            box-shadow: 0 0 25px rgba(0, 0, 0, 0.3);
            z-index: 100;
        }
        
        .sidebar h2 {
            padding: 0 20px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 20px;
            background: linear-gradient(135deg, #8b5cf6, #ec4899);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: 700;
        }
        
        .sidebar ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        
        .sidebar ul li {
            margin-bottom: 5px;
        }
        
        .sidebar ul li a {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            color: #a78bfa;
            text-decoration: none;
            transition: all 0.3s ease;
            border-radius: 0 20px 20px 0;
            margin-right: 1rem;
        }
        
        .sidebar ul li a:hover {
            background: rgba(139, 92, 246, 0.2);
            color: #c4b5fd;
            transform: translateX(8px);
        }
        
        .sidebar ul li.active a {
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
            color: white;
            box-shadow: 0 8px 25px rgba(139, 92, 246, 0.4);
        }
        
        .sidebar ul li a i {
            margin-right: 10px;
            width: 20px;
            text-align: center;
        }
        
        .main-content {
            flex: 1;
            margin-left: 260px;
            padding: 30px;
        }
        
        h1 {
            margin-bottom: 30px;
            color: #e0e7ff;
            font-weight: 600;
            font-size: 28px;
            background: linear-gradient(135deg, #8b5cf6, #ec4899);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        h3 {
            color: #a78bfa;
            font-weight: 500;
            font-size: 16px;
            margin-bottom: 15px;
        }
        
        .glass-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
            padding: 30px;
            margin-bottom: 30px;
        }
        
        .glass-card:hover {
            background: rgba(255, 255, 255, 0.08);
            transform: translateY(-2px);
        }
        
        .form-group {
            margin-bottom: 25px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #a78bfa;
            font-weight: 500;
            font-size: 14px;
        }
        
        .form-group input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            color: #e0e7ff;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        .form-group input:focus {
            outline: none;
            border-color: #8b5cf6;
            background: rgba(255, 255, 255, 0.08);
            box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.2);
        }
        
        .form-group.error input {
            border-color: #ef4444 !important;
            background: rgba(239, 68, 68, 0.1) !important;
            animation: shake 0.5s ease-in-out;
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        
        .error-message {
            color: #fca5a5;
            font-size: 12px;
            margin-top: 8px;
            display: none;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .form-group.error .error-message {
            display: block;
            opacity: 1;
        }
        
        .success-indicator {
            color: #10b981;
            font-size: 12px;
            margin-top: 8px;
            display: none;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .form-group.valid .success-indicator {
            display: block;
            opacity: 1;
        }
        
        .switch-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
            border-radius: 8px;
            margin-bottom: 10px;
        }
        
        .switch-container:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }
        
        .switch-container:hover {
            background: rgba(139, 92, 246, 0.05);
            transform: translateX(5px);
        }
        
        .switch-info {
            flex: 1;
        }
        
        .switch-info h4 {
            color: #e0e7ff;
            font-weight: 500;
            margin-bottom: 4px;
        }
        
        .switch-info p {
            color: #a78bfa;
            font-size: 13px;
            opacity: 0.8;
        }
        
        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 30px;
        }
        
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.2);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 30px;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        .slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 4px;
            bottom: 4px;
            background: white;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 50%;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }
        
        input:checked + .slider {
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
            box-shadow: 0 0 20px rgba(139, 92, 246, 0.4);
        }
        
        input:checked + .slider:before {
            transform: translateX(30px);
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.4);
        }
        
        .btn {
            padding: 12px 24px;
            border-radius: 12px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            font-size: 14px;
            margin-right: 15px;
            position: relative;
            overflow: hidden;
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
            color: white;
        }
        
        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(139, 92, 246, 0.4);
        }
        
        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: #e0e7ff;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .btn-secondary:hover:not(:disabled) {
            background: rgba(255, 255, 255, 0.15);
            border-color: #8b5cf6;
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
        }
        
        .btn-danger:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(239, 68, 68, 0.4);
        }
        
        .flash-message {
            padding: 16px 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            animation: slideInDown 0.5s ease-out;
        }
        
        @keyframes slideInDown {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        .flash-message.success {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.3);
            border-left: 4px solid #10b981;
            color: #6ee7b7;
        }
        
        .flash-message.error {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-left: 4px solid #ef4444;
            color: #fca5a5;
        }
        
        .flash-message i {
            margin-right: 12px;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .status-indicator {
            display: inline-flex;
            align-items: center;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .status-indicator.active {
            background: rgba(16, 185, 129, 0.2);
            color: #6ee7b7;
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }
        
        .loading-content {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 16px;
            padding: 40px;
            text-align: center;
            color: #e0e7ff;
            animation: fadeIn 0.3s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.8); }
            to { opacity: 1; transform: scale(1); }
        }
        
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #8b5cf6;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .ripple {
            position: absolute;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.6);
            transform: scale(0);
            animation: ripple-effect 0.6s linear;
            pointer-events: none;
        }
        
        @keyframes ripple-effect {
            to {
                transform: scale(4);
                opacity: 0;
            }
        }
        
        .section-divider {
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(139, 92, 246, 0.3), transparent);
            margin: 30px 0;
        }
        
        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }
        
        @media (max-width: 1024px) {
            .sidebar {
                transform: translateX(-100%);
            }
            
            .main-content {
                margin-left: 0;
                padding: 20px;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <aside class="sidebar">
            <h2>Admin Panel</h2>
            <ul>
                <li><a href="{{ url_for('admin.dashboard') }}"><i class="fas fa-chart-line"></i> Dashboard</a></li>
                <li><a href="{{ url_for('admin.user_management') }}"><i class="fas fa-users"></i> User Management</a></li>
                <li><a href="{{ url_for('admin.mood_reports') }}"><i class="fas fa-brain"></i> Mood Reports</a></li>
                <li><a href="{{ url_for('admin.moderation_dashboard') }}"><i class="fas fa-shield-alt"></i> Moderation Center</a></li>
                <li><a href="{{ url_for('admin.chat_logs') }}"><i class="fas fa-comments"></i> Chat Logs</a></li>
                <li><a href="{{ url_for('admin.budget_dashboard') }}"><i class="fas fa-dollar-sign"></i> Budget Dashboard</a></li>
                <li><a href="{{ url_for('admin.resources') }}"><i class="fas fa-book"></i> Resource Management</a></li>
                <li class="active"><a href="{{ url_for('admin.settings') }}"><i class="fas fa-cog"></i> System Settings</a></li>
                <li><a href="{{ url_for('auth.logout') }}"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
            </ul>
        </aside>
        
        <div class="main-content">
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        <div class="flash-message {{ category }}">
                            {% if category == 'success' %}
                                <i class="fas fa-check-circle"></i>
                            {% elif category == 'error' %}
                                <i class="fas fa-exclamation-circle"></i>
                            {% else %}
                                <i class="fas fa-info-circle"></i>
                            {% endif %}
                            {{ message }}
                        </div>
                    {% endfor %}
                {% endif %}
            {% endwith %}
            
            <h1><i class="fas fa-cog" style="margin-right: 15px;"></i>System Settings</h1>
            
            <form id="settingsForm" method="POST" action="{{ url_for('admin.settings') }}">
                <div class="glass-card">
                    <h3><i class="fas fa-calendar-alt" style="margin-right: 10px;"></i>Session Management</h3>
                    <p style="color: #a78bfa; margin-bottom: 25px; font-size: 14px;">
                        Configure session limits and scheduling defaults for the therapy system.
                    </p>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="max_sessions_per_student">
                                <i class="fas fa-users" style="margin-right: 5px;"></i>Max Sessions per Student
                            </label>
                            <input type="number" 
                                   id="max_sessions_per_student" 
                                   name="max_sessions_per_student" 
                                   value="{{ settings.max_sessions_per_student or 10 }}" 
                                   min="1" 
                                   max="50"
                                   required>
                            <div class="error-message">Please enter a value between 1 and 50</div>
                            <div class="success-indicator"><i class="fas fa-check"></i> Valid value</div>
                        </div>
                        
                        <div class="form-group">
                            <label for="default_session_duration">
                                <i class="fas fa-clock" style="margin-right: 5px;"></i>Default Session Duration (minutes)
                            </label>
                            <input type="number" 
                                   id="default_session_duration" 
                                   name="default_session_duration" 
                                   value="{{ settings.default_session_duration or 50 }}" 
                                   min="15" 
                                   max="120" 
                                   step="5"
                                   required>
                            <div class="error-message">Please enter a value between 15 and 120 minutes</div>
                            <div class="success-indicator"><i class="fas fa-check"></i> Valid value</div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="minimum_cancellation_hours">
                            <i class="fas fa-exclamation-triangle" style="margin-right: 5px;"></i>Minimum Cancellation Hours
                        </label>
                        <input type="number" 
                               id="minimum_cancellation_hours" 
                               name="minimum_cancellation_hours" 
                               value="{{ settings.minimum_cancellation_hours or 24 }}" 
                               min="1" 
                               max="168"
                               required>
                        <small style="color: #64748b; font-size: 12px; display: block; margin-top: 5px;">
                            Hours before session start that cancellation is allowed
                        </small>
                        <div class="error-message">Please enter a value between 1 and 168 hours</div>
                        <div class="success-indicator"><i class="fas fa-check"></i> Valid value</div>
                    </div>
                </div>
                
                <div class="glass-card">
                    <h3><i class="fas fa-robot" style="margin-right: 10px;"></i>System Behavior</h3>
                    <p style="color: #a78bfa; margin-bottom: 25px; font-size: 14px;">
                        Control automated system behaviors and user permissions.
                    </p>
                    
                    <div class="switch-container">
                        <div class="switch-info">
                            <h4>Auto-Assignment</h4>
                            <p>Automatically assign students to available therapists</p>
                        </div>
                        <label class="switch">
                            <input type="checkbox" 
                                   name="auto_assignment_enabled" 
                                   {% if settings.auto_assignment_enabled %}checked{% endif %}>
                            <span class="slider"></span>
                        </label>
                    </div>
                    
                    <div class="switch-container">
                        <div class="switch-info">
                            <h4>Self-Cancellation</h4>
                            <p>Allow students to cancel their own appointments</p>
                        </div>
                        <label class="switch">
                            <input type="checkbox" 
                                   name="allow_self_cancellation" 
                                   {% if settings.allow_self_cancellation %}checked{% endif %}>
                            <span class="slider"></span>
                        </label>
                    </div>
                    
                    <div class="switch-container">
                        <div class="switch-info">
                            <h4>Default Resources Visibility</h4>
                            <p>Make resources visible to all users by default</p>
                        </div>
                        <label class="switch">
                            <input type="checkbox" 
                                   name="default_resources_visible" 
                                   {% if settings.default_resources_visible %}checked{% endif %}>
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>
                
                <div class="glass-card">
                    <h3><i class="fas fa-bell" style="margin-right: 10px;"></i>Notification Settings</h3>
                    <p style="color: #a78bfa; margin-bottom: 25px; font-size: 14px;">
                        Configure system notifications and alerts.
                    </p>
                    
                    <div class="switch-container">
                        <div class="switch-info">
                            <h4>Email Notifications</h4>
                            <p>Send email notifications for appointments and updates</p>
                        </div>
                        <label class="switch">
                            <input type="checkbox" 
                                   name="email_notifications" 
                                   {% if settings.notification_settings and settings.notification_settings.email_notifications %}checked{% endif %}>
                            <span class="slider"></span>
                        </label>
                    </div>
                    
                    <div class="switch-container">
                        <div class="switch-info">
                            <h4>Admin Notifications</h4>
                            <p>Send notifications to administrators for system events</p>
                        </div>
                        <label class="switch">
                            <input type="checkbox" 
                                   name="admin_notifications" 
                                   {% if settings.notification_settings and settings.notification_settings.admin_notifications %}checked{% endif %}>
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>
                
                <div class="glass-card">
                    <h3><i class="fas fa-info-circle" style="margin-right: 10px;"></i>System Information</h3>
                    <div class="settings-grid">
                        <div>
                            <h4 style="color: #e0e7ff; margin-bottom: 10px;">Last Updated</h4>
                            <p style="color: #a78bfa;">
                                {% if settings.updated_at %}
                                    {{ settings.updated_at.strftime('%Y-%m-%d %H:%M UTC') }}
                                {% else %}
                                    Never
                                {% endif %}
                            </p>
                        </div>
                        <div>
                            <h4 style="color: #e0e7ff; margin-bottom: 10px;">Created</h4>
                            <p style="color: #a78bfa;">
                                {% if settings.created_at %}
                                    {{ settings.created_at.strftime('%Y-%m-%d %H:%M UTC') }}
                                {% else %}
                                    Unknown
                                {% endif %}
                            </p>
                        </div>
                        <div>
                            <h4 style="color: #e0e7ff; margin-bottom: 10px;">Session Types</h4>
                            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                {% if settings.session_types %}
                                    {% for session_type in settings.session_types %}
                                        <span class="status-indicator active">{{ session_type }}</span>
                                    {% endfor %}
                                {% else %}
                                    <span class="status-indicator active">online</span>
                                    <span class="status-indicator active">in_person</span>
                                {% endif %}
                            </div>
                        </div>
                        <div>
                            <h4 style="color: #e0e7ff; margin-bottom: 10px;">System Status</h4>
                            <span class="status-indicator active">
                                <i class="fas fa-check-circle" style="margin-right: 5px;"></i>Operational
                            </span>
                        </div>
                    </div>
                </div>
                
                <div class="section-divider"></div>
                
                <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 30px; flex-wrap: wrap; gap: 15px;">
                    <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                        <button type="submit" class="btn btn-primary" id="saveBtn">
                            <i class="fas fa-save" style="margin-right: 8px;"></i>Save Settings
                        </button>
                        <a href="{{ url_for('admin.dashboard') }}" class="btn btn-secondary">
                            <i class="fas fa-arrow-left" style="margin-right: 8px;"></i>Back to Dashboard
                        </a>
                    </div>
                    
                    <div>
                        <button type="button" class="btn btn-danger" id="resetBtn">
                            <i class="fas fa-undo" style="margin-right: 8px;"></i>Reset to Defaults
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="spinner"></div>
            <p>Saving settings...</p>
        </div>
    </div>

    <script>
        // Debugging flag
        const DEBUG = true;
        
        function log(...args) {
            if (DEBUG) console.log('[Settings]', ...args);
        }
        
        // Real-time validation function
        function validateField(input) {
            log('Validating field:', input.name, 'Value:', input.value);
            
            const value = parseFloat(input.value);
            const min = parseFloat(input.min);
            const max = parseFloat(input.max);
            const formGroup = input.closest('.form-group');
            
            // Remove existing classes
            formGroup.classList.remove('error', 'valid');
            
            // Check if value is valid
            if (isNaN(value) || value < min || value > max || input.value.trim() === '') {
                formGroup.classList.add('error');
                log('Validation failed for:', input.name);
                return false;
            } else {
                formGroup.classList.add('valid');
                log('Validation passed for:', input.name);
                return true;
            }
        }
        
        // Show notification with real-time animation
        function showNotification(message, type = 'success') {
            log('Showing notification:', message, type);
            
            // Remove existing notifications with animation
            document.querySelectorAll('.flash-message').forEach(notification => {
                notification.style.animation = 'slideInDown 0.3s ease-out reverse';
                setTimeout(() => notification.remove(), 300);
            });
            
            // Create new notification
            const notification = document.createElement('div');
            notification.className = `flash-message ${type}`;
            
            const icon = type === 'success' ? 'fas fa-check-circle' : 'fas fa-exclamation-circle';
            notification.innerHTML = `<i class="${icon}"></i>${message}`;
            
            // Insert at the top
            const mainContent = document.querySelector('.main-content');
            const h1 = mainContent.querySelector('h1');
            mainContent.insertBefore(notification, h1.nextSibling);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.style.animation = 'slideInDown 0.3s ease-out reverse';
                    setTimeout(() => notification.remove(), 300);
                }
            }, 5000);
        }
        
        // Reset to defaults with real-time feedback
        function resetToDefaults() {
            log('Reset to defaults clicked');
            
            if (confirm('Are you sure you want to reset all settings to their default values? This action cannot be undone.')) {
                log('User confirmed reset');
                
                // Reset number inputs with animation
                const inputs = [
                    { id: 'max_sessions_per_student', value: '10' },
                    { id: 'default_session_duration', value: '50' },
                    { id: 'minimum_cancellation_hours', value: '24' }
                ];
                
                inputs.forEach(input => {
                    const field = document.getElementById(input.id);
                    if (field) {
                        field.style.transform = 'scale(1.05)';
                        field.value = input.value;
                        validateField(field);
                        setTimeout(() => {
                            field.style.transform = 'scale(1)';
                        }, 200);
                    }
                });
                
                // Reset checkboxes with animation
                const checkboxes = [
                    { name: 'auto_assignment_enabled', checked: true },
                    { name: 'allow_self_cancellation', checked: false },
                    { name: 'default_resources_visible', checked: true },
                    { name: 'email_notifications', checked: true },
                    { name: 'admin_notifications', checked: true }
                ];
                
                checkboxes.forEach(checkbox => {
                    const field = document.querySelector(`input[name="${checkbox.name}"]`);
                    if (field) {
                        const slider = field.nextElementSibling;
                        slider.style.transform = 'scale(1.1)';
                        field.checked = checkbox.checked;
                        
                        // Trigger change event for switch animation
                        field.dispatchEvent(new Event('change'));
                        
                        setTimeout(() => {
                            slider.style.transform = 'scale(1)';
                        }, 300);
                    }
                });
                
                // Clear validation states
                document.querySelectorAll('.form-group').forEach(group => {
                    group.classList.remove('error', 'valid');
                });
                
                showNotification('Settings have been reset to defaults. Click "Save Settings" to apply changes.', 'success');
            }
        }
        
        // Add ripple effect to buttons
        function addRippleEffect(button, event) {
            log('Adding ripple effect to button');
            
            const rect = button.getBoundingClientRect();
            const size = Math.max(rect.width, rect.height);
            const x = event.clientX - rect.left - size / 2;
            const y = event.clientY - rect.top - size / 2;
            
            const ripple = document.createElement('span');
            ripple.className = 'ripple';
            ripple.style.width = ripple.style.height = size + 'px';
            ripple.style.left = x + 'px';
            ripple.style.top = y + 'px';
            
            button.appendChild(ripple);
            
            // Remove ripple after animation
            setTimeout(() => {
                if (ripple.parentNode) {
                    ripple.remove();
                }
            }, 600);
        }
        
        // Auto-save draft functionality
        function saveDraft() {
            const formData = new FormData(document.getElementById('settingsForm'));
            const draft = {};
            
            // Save all form values
            for (let [key, value] of formData.entries()) {
                draft[key] = value === 'on' ? true : value;
            }
            
            // Also save unchecked checkboxes
            document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                if (!checkbox.checked) {
                    draft[checkbox.name] = false;
                }
            });
            
            localStorage.setItem('settingsDraft', JSON.stringify(draft));
            log('Draft saved:', draft);
        }
        
        // Load draft on page load
        function loadDraft() {
            const draft = localStorage.getItem('settingsDraft');
            if (draft) {
                try {
                    const draftData = JSON.parse(draft);
                    log('Found draft data:', draftData);
                    
                    if (confirm('Found unsaved changes. Would you like to restore them?')) {
                        Object.keys(draftData).forEach(key => {
                            const field = document.querySelector(`[name="${key}"]`);
                            if (field) {
                                if (field.type === 'checkbox') {
                                    field.checked = draftData[key] === true;
                                    // Trigger change event for visual feedback
                                    field.dispatchEvent(new Event('change'));
                                } else {
                                    field.value = draftData[key];
                                    // Validate restored values
                                    if (field.type === 'number') {
                                        validateField(field);
                                    }
                                }
                            }
                        });
                        
                        showNotification('Draft settings restored!', 'success');
                    }
                    
                    // Clear the draft after loading
                    localStorage.removeItem('settingsDraft');
                } catch (e) {
                    console.error('Error loading draft:', e);
                    localStorage.removeItem('settingsDraft');
                }
            }
        }
        
        // Initialize everything when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            log('DOM loaded, initializing settings page...');
            
            // Load any saved draft
            loadDraft();
            
            // Set up real-time validation for number inputs
            const numberInputs = document.querySelectorAll('input[type="number"]');
            log('Found', numberInputs.length, 'number inputs');
            
            numberInputs.forEach((input, index) => {
                log(`Setting up input ${index + 1}: ${input.name}`);
                
                // Validate on input (real-time)
                input.addEventListener('input', function() {
                    log('Input event on:', this.name, 'Value:', this.value);
                    validateField(this);
                    saveDraft(); // Auto-save on change
                });
                
                // Validate on blur
                input.addEventListener('blur', function() {
                    log('Blur event on:', this.name);
                    validateField(this);
                });
                
                // Validate on focus to clear any errors
                input.addEventListener('focus', function() {
                    log('Focus event on:', this.name);
                    const formGroup = this.closest('.form-group');
                    if (formGroup.classList.contains('error')) {
                        formGroup.classList.remove('error');
                    }
                });
                
                // Initial validation
                validateField(input);
            });
            
            // Set up switch animations and auto-save
            const switches = document.querySelectorAll('.switch input[type="checkbox"]');
            log('Found', switches.length, 'switches');
            
            switches.forEach((switchInput, index) => {
                log(`Setting up switch ${index + 1}: ${switchInput.name}`);
                
                switchInput.addEventListener('change', function() {
                    log('Switch changed:', this.name, 'Checked:', this.checked);
                    
                    const slider = this.nextElementSibling;
                    
                    // Add visual feedback
                    slider.style.transform = 'scale(0.95)';
                    setTimeout(() => {
                        slider.style.transform = 'scale(1)';
                    }, 150);
                    
                    // Save draft
                    saveDraft();
                });
            });
            
            // Set up button ripple effects
            const buttons = document.querySelectorAll('.btn');
            log('Found', buttons.length, 'buttons');
            
            buttons.forEach((button, index) => {
                log(`Setting up button ${index + 1}: ${button.textContent.trim()}`);
                
                button.addEventListener('click', function(e) {
                    if (!this.disabled) {
                        addRippleEffect(this, e);
                    }
                });
            });
            
            // Set up reset button
            const resetBtn = document.getElementById('resetBtn');
            if (resetBtn) {
                log('Setting up reset button');
                resetBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    resetToDefaults();
                });
            }
            
            log('Settings page initialization complete');
        });
        
        // Form submission with validation
        document.getElementById('settingsForm').addEventListener('submit', function(e) {
            log('Form submission attempted');
            e.preventDefault();
            
            // Validate all number inputs
            const numberInputs = document.querySelectorAll('input[type="number"]');
            let isValid = true;
            let invalidFields = [];
            
            numberInputs.forEach(input => {
                if (!validateField(input)) {
                    isValid = false;
                    invalidFields.push(input.name);
                }
            });
            
            if (!isValid) {
                log('Form validation failed. Invalid fields:', invalidFields);
                showNotification('Please fix the validation errors before saving.', 'error');
                
                // Focus on first error field
                const firstError = document.querySelector('.form-group.error input');
                if (firstError) {
                    firstError.focus();
                    firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
                return;
            }
            
            log('Form validation passed, submitting...');
            
            // Show loading overlay
            const loadingOverlay = document.getElementById('loadingOverlay');
            loadingOverlay.style.display = 'flex';
            
            // Disable form elements
            const formElements = this.querySelectorAll('input, button, select');
            formElements.forEach(element => {
                element.disabled = true;
            });
            
            // Clear draft since we're submitting
            localStorage.removeItem('settingsDraft');
            
            // Submit the form
            setTimeout(() => {
                this.submit();
            }, 500); // Small delay to show loading animation
        });
        
        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            // Ctrl+S or Cmd+S to save
            if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                e.preventDefault();
                log('Keyboard shortcut: Save');
                document.getElementById('saveBtn').click();
            }
            
            // Ctrl+R or Cmd+R to reset
            if ((e.ctrlKey || e.metaKey) && e.key === 'r') {
                e.preventDefault();
                log('Keyboard shortcut: Reset');
                resetToDefaults();
            }
        });
        
        // Prevent form resubmission on page reload
        if (window.history.replaceState) {
            window.history.replaceState(null, null, window.location.href);
        }
        
        // Handle browser back button during form submission
        window.addEventListener('beforeunload', function(e) {
            const loadingOverlay = document.getElementById('loadingOverlay');
            if (loadingOverlay.style.display === 'flex') {
                e.preventDefault();
                e.returnValue = 'Settings are being saved. Are you sure you want to leave?';
                return e.returnValue;
            }
        });
        
        // Test functions for debugging (remove in production)
        window.testValidation = function() {
            log('Testing validation...');
            const input = document.getElementById('max_sessions_per_student');
            input.value = '100'; // Invalid value
            validateField(input);
            setTimeout(() => {
                input.value = '10'; // Valid value
                validateField(input);
            }, 2000);
        };
        
        window.testNotification = function(type = 'success') {
            showNotification(`Test ${type} notification`, type);
        };
        
        window.testReset = function() {
            resetToDefaults();
        };
        
        log('All settings page scripts loaded successfully');
        log('Debug functions available: testValidation(), testNotification(), testReset()');
    </script>
</body>
</html>